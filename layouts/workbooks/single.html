{{ define "main" }}
<main class="td-main">
  <div class="td-content workbook-container">

    <h1>{{ .Title }}</h1>

    {{ $.Scratch.Set "inWorkbook" true }}

    {{ with .Content }}
      <div class="workbook-intro">
        {{ . }}
      </div>
    {{ end }}

    {{ $id := .Params.workbookId }}
    {{ if not $id }}
      <p><strong>Fehlende <code>workbookId</code> im Frontmatter.</strong></p>
    {{ else }}
      {{ $wb := index site.Data.workbooks $id }}
      {{ if not $wb }}
        <p><strong>Workbook '{{ $id }}' wurde in <code>data/workbooks</code> nicht gefunden.</strong></p>
      {{ else }}

        {{/* Kapitelanzahl ermitteln */}}
        {{ $total := len $wb.chapters }}

        <div id="pages">
        {{/* Wir rendern alle Seiten, zeigen aber per CSS immer nur eine */}}
        {{ range $index, $chapter := $wb.chapters }}
          {{ $p := site.GetPage $chapter }}
          {{ if $p }}
            <article class="page" data-page="{{ add $index 1 }}">
              <hr>
              <h2>{{ $p.Title }}</h2>
              <p class="lead">{{ $p.Description }}</p>
              {{ $p.Content }}
            </article>
          {{ else }}
            <article class="page missing" data-page="{{ add $index 1 }}">
               <p><em>Fehlende Seite: {{ $chapter }}</em></p>
            </article>
          {{ end }}
        {{ end }}
        </div>

        {{/* Navigation */}}
        <div class="pagination-nav-fixed">
          <button id="prevBtn" class="btn btn-secondary">← Zurück</button>

          <span id="pagination-info" class="pagination-info"></span>

          <button id="nextBtn" class="btn btn-primary">Weiter →</button>
        </div>

      {{ end }}
    {{ end }}

    {{ $.Scratch.Set "inWorkbook" false }}
  </div>
</main>

<div id="overlay" class="overlay hidden"></div>

<div id="popup" class="popup hidden">
  <div class="popup-header">
    <button class="btn btn-light" id="open-window">Open in Window</button>
    <button class="btn btn-dark" id="open-sidebar">Open in Sidebar</button>
    <button class="btn btn-danger" id="close-popup">Close</button>
  </div>
  <iframe id="popup-iframe"></iframe>
</div>

<div id="sidebar" class="sidebar hidden">
  <div class="sidebar-header">
    <span>Sidebar</span>
    <button class="btn btn-danger" id="sidebar-close">×</button>
  </div>
  <iframe id="sidebar-iframe"></iframe>
  <div id="sidebar-resizer"></div>
</div>


{{/* --- JS + CSS --- */}}

<style>

  .pagination-nav {
    margin-top: 40px;
    display:flex;
    justify-content: space-between;
  }

  .page { 
    display:none; 
    opacity:0; 
    transition: opacity 0.3s ease; 
    margin-bottom: 120px; /* Platz für fixe Navigation */ 
  }
  .page.active { 
    display:block; 
    opacity:1; 
  }

  /* Fixierte Navigation unten */
  .pagination-nav-fixed {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #ffffff;
    border-top: 1px solid #ddd;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 999;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
  }

  .pagination-info {
    font-weight: bold;
    font-size: 1.1em;
    margin: 0 15px;
  }

  /* Popup */
  .popup {
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    width: 70%;
    height: 70%;
    background: white;
    border-radius: 8px;
    box-shadow: 0 0 20px rgba(0,0,0,0.4);
    display: flex;
    flex-direction: column;
    z-index: 9999;
  }
  .popup.hidden { display: none; }

  .popup-header {
    padding: 10px;
    background: #2d2d2d;
    color: white;
    display: flex;
    gap: 10px;
  }
  .popup iframe {
    flex: 1;
    border: none;
  }

  /* Overlay */
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 9998;
  }
  .overlay.hidden { display: none; }

  /* Sidebar */
  .sidebar {
    position: fixed;
    top: 0;
    right: 0;
    width: 40%;
    height: 100%;
    background: white;
    border-left: 2px solid #ccc;
    display: flex;
    flex-direction: column;
    z-index: 9997;
  }
  .sidebar.hidden { display: none; }

  .sidebar-header {
    padding: 10px;
    background: #eee;
    display: flex;
    justify-content: space-between;
  }

  #sidebar-iframe {
    flex: 1;
    border: none;
  }

  #sidebar-resizer {
    width: 6px;
    cursor: ew-resize;
    background: #ccc;
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
  }

</style>

<script>

  let scrollLock = false;

  function attachScrollPaging() {

    pages.forEach(p => {

      p.addEventListener("wheel", function(e) {

        if (!p.classList.contains("active")) return;
        if (scrollLock) return;

        const atBottom = p.scrollTop + p.clientHeight >= p.scrollHeight - 2;
        const atTop    = p.scrollTop <= 2;

        // Scroll nach unten am Seitenende
        if (e.deltaY > 0 && atBottom) {
          scrollLock = true;
          showPage(current + 1, "next");
          setTimeout(() => scrollLock = false, 400);
        }

        // Scroll nach oben am Seitenanfang
        if (e.deltaY < 0 && atTop) {
          scrollLock = true;
          showPage(current - 1, "prev");
          setTimeout(() => scrollLock = false, 400);
        }
      });
    });
  }


  document.addEventListener("DOMContentLoaded", function () {

    let pages = Array.from(document.querySelectorAll(".page"));
    let current = 1;
    const total = pages.length;

    // Speichert pro Seite die letzte Scrollposition
    let scrollMemory = {};

    function showPage(n, direction = "next") {

      // Speichere Scrollposition der aktuellen Seite
      let active = document.querySelector(`.page[data-page="${current}"]`);
      if (active) {
        scrollMemory[current] = active.scrollTop;
      }

      if (n < 1 || n > total) return;

      pages.forEach(p => p.classList.remove("active"));
      let newPage = document.querySelector(`.page[data-page="${n}"]`);
      newPage.classList.add("active");

      // Standardverhalten beim Weiterblättern: oben
      if (direction === "next") {
        newPage.scrollTop = 0;
      }

      // Standardverhalten beim Zurückblättern: unten
      if (direction === "prev") {
        newPage.scrollTop = newPage.scrollHeight;
      }

      // Falls wir bereits auf der Seite waren → alte Scrollposition nutzen
      if (scrollMemory[n] !== undefined) {
        newPage.scrollTop = scrollMemory[n];
      }

      current = n;
      updateUI();
    }

    function updateUI() {
      document.getElementById("pagination-info").textContent =
        `Kapitel ${current} / ${total}`;

      document.getElementById("prevBtn").disabled = current === 1;
      document.getElementById("nextBtn").disabled = current === total;
    }

    document.getElementById("nextBtn").addEventListener("click", () =>
      showPage(current + 1, "next")
    );

    document.getElementById("prevBtn").addEventListener("click", () =>
      showPage(current - 1, "prev")
    );

    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft") showPage(current - 1, "prev");
      if (e.key === "ArrowRight") showPage(current + 1, "next");
    });

    // Start bei Seite 1
    showPage(1);
    attachScrollPaging();
  });

  document.addEventListener("DOMContentLoaded", () => {

    const popup = document.getElementById("popup");
    const popupIframe = document.getElementById("popup-iframe");


    function cleanupIframe(iframe) {
      try {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        if (!doc) return;

        // Nur bei internen Seiten aufräumen (gleicher Origin)
        const src = iframe.src;
        const sameOrigin =
          src.startsWith(window.location.origin) || src.startsWith("/");

        if (!sameOrigin) return;

        const main = doc.querySelector("main.td-main");
        if (!main) return;

        // Variante A: Nur main anzeigen, Rest weg
        doc.body.innerHTML = "";
        doc.body.appendChild(main);

        // Optional etwas Styling
        doc.body.style.margin = "0";
        doc.body.style.padding = "0";

      } catch (e) {
        // Cross-Origin → ignorieren
        console.warn("Could not clean iframe content:", e);
      }
    }

    const overlay = document.getElementById("overlay");

    const sidebar = document.getElementById("sidebar");
    const sidebarIframe = document.getElementById("sidebar-iframe");
    const sidebarResizer = document.getElementById("sidebar-resizer");

    if (popupIframe) {
      popupIframe.addEventListener("load", () => cleanupIframe(popupIframe));
    }

    if (sidebarIframe) {
      sidebarIframe.addEventListener("load", () => cleanupIframe(sidebarIframe));
    }


    /* ------------------------------------------
      1. HOOK FÜR ALLE LINKS
    ------------------------------------------ */
    document.querySelectorAll(".page a").forEach(a => {
      a.addEventListener("click", (e) => {
        e.preventDefault();
        const url = a.href;

        openPopup(url);
      });
    });

    /* ------------------------------------------
      2. POPUP FUNKTIONEN
    ------------------------------------------ */
    function openPopup(url) {
      popupIframe.src = url;
      popup.classList.remove("hidden");
      overlay.classList.remove("hidden");
    }

    document.getElementById("close-popup").onclick = closePopup;

    function closePopup() {
      popup.classList.add("hidden");
      overlay.classList.add("hidden");
      popupIframe.src = "";
    }

    document.getElementById("open-window").onclick = () => {
      window.open(popupIframe.src, "_blank");
      closePopup();
    };

    document.getElementById("open-sidebar").onclick = () => {
      openSidebar(popupIframe.src);
      closePopup();
    };

    /* ------------------------------------------
      3. SIDEBAR
    ------------------------------------------ */
    function openSidebar(url) {
      sidebarIframe.src = url;
      sidebar.classList.remove("hidden");
    }

    document.getElementById("sidebar-close").onclick = () => {
      sidebar.classList.add("hidden");
      sidebarIframe.src = "";
    };

    /* Resize Sidebar */
    sidebarResizer.addEventListener("mousedown", initResize);

    function initResize(e) {
      window.addEventListener("mousemove", resizeSidebar);
      window.addEventListener("mouseup", stopResize);
    }

    function resizeSidebar(e) {
      const newWidth = window.innerWidth - e.clientX;
      sidebar.style.width = Math.max(250, Math.min(newWidth, 900)) + "px";
    }

    function stopResize() {
      window.removeEventListener("mousemove", resizeSidebar);
      window.removeEventListener("mouseup", stopResize);
    }
  });
</script>

{{ end }}
